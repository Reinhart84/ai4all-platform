name: 🔄 Firebase Deploy (Hosting + Functions, prod & staging)

on:
  push:
    branches:
      - main
      - staging

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout
        uses: actions/checkout@v4

      - name: 🔐 Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # ---- Install & build FUNCTIONS (always install; deploy only on main) ----
      - name: 📦 Install functions deps
        working-directory: ./functions
        run: npm ci

      # ---- Install & build FRONTEND ----
      - name: 📦 Install frontend deps
        working-directory: ./frontend
        run: npm ci

      - name: 🏗️ Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: 🗂️ Prepare hosting-public (supports Vite dist or CRA build)
        shell: bash
        run: |
          set -e
          rm -rf hosting-public
          if [ -d "./frontend/dist" ]; then
            cp -a ./frontend/dist ./hosting-public
          elif [ -d "./frontend/build" ]; then
            cp -a ./frontend/build ./hosting-public
          else
            echo "❌ No frontend build output found (expected ./frontend/dist or ./frontend/build)"
            exit 1
          fi

      # ---- Deploy logic per branch ----
      - name: 🚀 Deploy STAGING hosting (branch=staging)
        if: github.ref == 'refs/heads/staging'
        run: |
          npx firebase-tools deploy \
            --project ai4all-platform-fe2e4 \
            --only hosting:staging

      - name: 🚀 Deploy PRODUCTION (hosting + functions) (branch=main)
        if: github.ref == 'refs/heads/main'
        run: |
          npx firebase-tools deploy \
            --project ai4all-platform-fe2e4 \
            --only hosting:production,functions
